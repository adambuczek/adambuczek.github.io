<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><style type="text/css">*{box-sizing:border-box}html{font-size:16px}body{font-family:sans-serif;font-size:1rem;line-height:1.5rem}nav{margin:1rem 5%}body,nav ul{margin:0;padding:0}nav li{display:inline;margin:0 1rem}nav li:first-child{margin-left:0}@media screen and (min-width:670px){nav{margin-left:1rem}}main{width:90%;max-width:720px;margin:3rem auto}em,h1,h1 span,h2,h2 span,h3,h3 span,h4,h4 span,li code,p code,strong{background:linear-gradient(90deg,#9e009e 0%,#ff007f 49%,#d98400 100%);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}h1,h2,h3,h4{font-family:sans-serif}h1{margin:2rem 0 1.5rem;font-size:2.5rem;line-height:3rem;font-weight:300;display:table}h2{margin:2rem 0 1rem;font-size:2rem;line-height:2.5rem;font-weight:400}h3,h4{font-weight:500}h3{font-size:1.5rem;line-height:2rem;margin:1rem 0 .5rem}blockquote,h4,iframe,ol,p,ul{font-size:1rem;line-height:1.5rem}h4{margin:.5rem 0}blockquote,hgroup,iframe,ol,p,ul{margin:1rem 0}hgroup h1,hgroup h2,hgroup h3,hgroup h4{margin:0}blockquote code,iframe code,ol code,p code,sup.footnote-ref,ul code{line-height:.5rem}ol,ul{padding:0 0 0 1.5rem}footer img{height:24px}section{padding:1rem 0}hr{margin:2rem 0}sup.footnote-ref{font-size:1rem}blockquote{border-left:6px rgba(1,1,1,.05) solid;background-color:rgba(1,1,1,.05);padding:.5rem .5rem .5rem 1rem}dt{margin-top:1rem}dd{margin-bottom:1rem;margin-left:1rem}</style><title>Adam Buczek | Building Vue apps in Vue app</title><meta name="description" content=""></head><body><nav><ul><li><a href="/">Adam Buczek</a></li>|<li><a href="/blog">Blog</a></li></ul></nav><main role="main"><span class="journal-entry--date">03 Dec 2020</span><img src="/assets/building-vue-apps-in-vue-app.png" alt="Building Vue apps in Vue app" title="Building Vue apps in Vue app"><h1>Building Vue apps in Vue app</h1><p>This is a second entry in <a href="../vue-website-builder">Vue based website builder</a> series. It covers the User Interface for creating web pages from prebuilt <a href="../building-vue-component-library">Vue components</a>.</p><h2>User Interface</h2><h3>Importing components asynchronously</h3><p>With component libraries prepared the way <a href="../building-vue-component-library">described earlier</a> I can now use a <a href="https://markus.oberlehner.net/blog/distributed-vue-applications-loading-components-via-http/">pattern created by Markus Oberlehner</a> to import components from a running static server. I load the external <code>manifest.json</code> file and render a list of available components as draggable UI elements allowing users to work with them.</p><p>When a component is dropped into the main area <code>loadExternalComponent.js</code> takes care of making it available to Vue as an <a href="https://vuejs.org/v2/guide/components-dynamic-async.html#Async-Components">async component</a>.</p><p>(Code sourced from <a href="https://markus.oberlehner.net/blog/distributed-vue-applications-loading-components-via-http/">here</a> with my comments.)</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// loadExternalComponent.js</span></span><br><span class="highlight-line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">externalComponent</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> name <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(.*?)\.umd</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">   <span class="token comment">// The registered component will be a global object.</span></span><br><span class="highlight-line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> window<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">   <span class="token comment">// We save a promise where the component will be in the future</span></span><br><span class="highlight-line">   <span class="token comment">// to prevent from fetching it multiple times.</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  window<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">     <span class="token comment">// Create new &lt;script> element and add resolve and reject on</span></span><br><span class="highlight-line">     <span class="token comment">// load and error events.</span></span><br><span class="highlight-line">  </span><br><span class="highlight-line">    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    script<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  </span><br><span class="highlight-line">       <span class="token comment">// This seems like we were trying to resolve the promise with</span></span><br><span class="highlight-line">       <span class="token comment">// itself which wouldn't work but when the load event fires</span></span><br><span class="highlight-line">       <span class="token comment">// window[name]'s value is already a Vue component.</span></span><br><span class="highlight-line">    </span><br><span class="highlight-line">      <span class="token function">resolve</span><span class="token punctuation">(</span>window<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    script<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error loading </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    script<span class="token punctuation">.</span>src <span class="token operator">=</span> url</span><br><span class="highlight-line">    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">return</span> window<span class="token punctuation">[</span>name<span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>Code above works as expected thanks to the <a href="https://cli.vuejs.org/guide/build-targets.html#library">Vue CLI Library target</a> option used when components were built. In short it depends on Vue being globally available and registers the component as <code>window[component-name]</code> by webpack's UMD implementation.</p><p>This is exactly why the promise resolves to the loaded component.</p><p>This way multiple component libraries may be used without over-bloating the app. Updates in libraries doesn't require the UI to be rebuilt and redeployed.</p><h3>Mounting components in isolation</h3><p>Imported components' styles need to be separated from the rest of the app. They need to be editable and reorderable. I mount them into new instances of Vue inside <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Using_shadow_DOM">ShadowDOM</a> root. CSS styles are injected next to the new app root.</p><p>In order to achieve this components are wrapped in listitem that creates a new vue app on mount. Initial empty props (declared in the manifest) are passed to ensure their reactivity later.</p><pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> ListItem <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'list-item'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token literal-property property">component</span><span class="token operator">:</span> Object<span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token literal-property property">data</span><span class="token operator">:</span> Object</span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">'host'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> host <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>host</span><br><span class="highlight-line">    </span><br><span class="highlight-line">    <span class="token keyword">const</span> <span class="token function-variable function">component</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span></span><br><span class="highlight-line">      <span class="token function">loadExternalComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token punctuation">.</span>script<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">h</span> <span class="token operator">=></span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">'1px dotted red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> shadowRoot <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> shadowApp <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token comment">/** Load Styles */</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> shadowStyle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    shadowStyle<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token punctuation">.</span>style</span><br><span class="highlight-line">    shadowStyle<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">'stylesheet'</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    shadowRoot<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>shadowApp<span class="token punctuation">)</span></span><br><span class="highlight-line">    shadowRoot<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>shadowStyle<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      render</span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>shadowApp<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>Those ListItems are rendered inside a draggable list and can be reordered. I used <a href="https://github.com/SortableJS/Vue.Draggable">Vue.Draggable</a> to create the drag and drop interface.</p><h4>Editing Data</h4><p>Manifest contains a list of available <a href="../building-vue-component-library#standardization-and-metadata">props for each component</a> which are later used to create an input for each prop. As for now all props receive strings, for simplicity, but they can virtually be anything.</p><h4>Exporting data</h4><p>Once the <em>Page</em> is complete it can be represented in a JSON form and saved or exported. It could look like this:</p><pre class="language-json"><code class="language-json"><span class="highlight-line"><span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token property">"components"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"description-component"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Lorem ipsum dolor sit, amet, consectetur, adipisci elit"</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"order"</span><span class="token operator">:</span> <span class="token number">0</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre><p>This data structure can be sent to an exporter which I am going to describe in the next part.</p><h2>Summary</h2><p>Web app building web app is ready. Although it lacks polish I can now create a simplistic web pages from parts I prepared earlier. The modules are also uncomplicated and lack interactivity but remember that we have whole functionality of Vue 2 to work with — this lets us create a system as robust as needed to be used with no knowledge of web development.</p></main><footer><ul><li><a href="https://www.linkedin.com/in/adamsbuczek/"><img src="/assets/linkedin.svg" alt="LinkedIn"></a></li><li><a href="https://github.com/adambuczek"><img src="/assets/github.svg" alt="Github"></a></li><li><a href="https://codepen.io/adambuczek"><img src="/assets/codepen.svg" alt="Codepen"></a></li></ul></footer><link href="/styles/global.css" rel="stylesheet" type="text/css"><link href="/styles/print.css" media="print" rel="stylesheet" type="text/css"></body></html>