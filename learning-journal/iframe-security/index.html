<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><style type="text/css">@import url(https://fonts.googleapis.com/css?family=Montserrat:300,400,600|Roboto+Slab);*{box-sizing:border-box}html{font-size:16px}body{font-family:'Roboto Slab',serif;padding:0;font-size:1rem;line-height:1.5rem}main{width:90%;max-width:600px;margin:3rem auto}h1,h2,h3,h4,h5{color:#30322d;font-family:'Montserrat',sans-serif}h2{font-weight:400;margin:2rem 0 1rem;font-size:2rem;line-height:2.5rem}h1{margin:2rem 0 1.5rem;font-size:2.5rem;line-height:3rem;font-weight:300}h3{margin:1rem 0 .5rem;font-size:1.5rem;line-height:2rem}h4,h5{margin:.5rem 0}h3,h4{font-weight:600}blockquote,h4,h5,iframe,ol,p,ul{font-size:1rem;line-height:1.5rem}h5{font-weight:400}blockquote,hgroup,iframe,ol,p,ul{margin:1rem 0}body,hgroup h1,hgroup h2,hgroup h3,hgroup h4,hgroup h5{margin:0}blockquote code,iframe code,ol code,p code,sup.footnote-ref,ul code{line-height:.5rem}ol,ul{padding:0 0 0 1rem}footer img{height:24px}section{padding:1rem 0}hr{margin:2rem 0}sup.footnote-ref{font-size:1rem}blockquote{border-left:6px rgba(1,1,1,.1) solid;background-color:rgba(1,1,1,.1);padding-left:1rem;padding-top:.5rem;padding-bottom:.5rem}</style><title>Adam Buczek | Iframe Security</title><meta name="description" content=""></head><body><main role="main"><span class="journal-entry--date">07 Jan 2019</span><h1>Iframe Security</h1><p>You have no control over sites that provide their functionality via embedded frames. 3rd party providers who offer their functionality for free usually gather user data to be sold to ad providers as a form of <em>payment</em>.</p><h2>Cross-origin Frames</h2><p>Modern browsers are non susceptible to cross-origin <code>iframes</code> tampering with embedding website.</p><p>This cross-origin frame doesn't have access to <code>top</code> frame which is the current website:</p><blockquote><p>Cross-origin frames may stop working at some point. Source used can be found at the <a href="#cross-origin-frame-source">bottom of this page</a>.</p></blockquote><iframe height="336" class="dotted-border" src="https://dev.adambuczek.com/iframe/" style="width: 100%;"></iframe><p>Opening this frame with provided button will show that it does have access to <code>opener</code> which is the <code>iframe</code> itself but it still can't access <code>opener.top</code>. Trying to change location of <code>opener.top</code> in newly opened window will produce an error. This fact prevents changing location of original site in the background which could be used in a phishing attack.</p><h2>Same-origin Frames</h2><p>For comparison same-origin <code>iframe</code> below (identical to the one above) has access to <code>top</code>. Widow opened with provided button has access to <code>opener.top</code> and can change location of <code>top</code> frame of its <code>opener</code>. Clicking the button in newly opened window will change location of current site to example.com.</p><iframe height="336" class="dotted-border" src="/iframe/" style="width: 100%;"></iframe><h2>Sandboxing</h2><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox"><code>sandbox</code></a> attribute allows for extra restrictions. Empty attribute will apply all restrictions.</p><h3>Same-origin Sandboxing</h3><p>In this case same-origin sandboxed frame without <code>allow-same-origin</code> always fails SOP checks. This will also disable to <code>opener</code> in window opened in new tab.</p><iframe height="336" class="dotted-border" sandbox="allow-scripts allow-popups" src="/iframe/" style="width: 100%;"></iframe><p>Removing <code>allow-popups</code> will disable opening new windows and tabs.</p><iframe height="336" class="dotted-border" sandbox="allow-scripts" src="/iframe/" style="width: 100%;"></iframe><p>Removing <code>allow-scripts</code> disables all JavaScript but not popups. <code>target=&quot;_blank&quot;</code> anchor will work, opened window will inherit script restriction. In this case frame will be mostly empty.</p><iframe height="336" class="dotted-border" sandbox="allow-popups" src="/iframe/" style="width: 100%;"></iframe><p>Adding <code>allow-popups-to-escape-sandbox</code> to the last case will allow script execution and <code>opener.top</code> access.</p><iframe height="336" class="dotted-border" sandbox="allow-popups allow-popups-to-escape-sandbox" src="/iframe/" style="width: 100%;"></iframe><h3>Cross-origin Sandboxing</h3><p>Omitting <code>allow-same-origin</code> on cross-origin <code>iframe</code> blocks <code>opener</code> in popups.</p><iframe height="336" class="dotted-border" src="https://dev.adambuczek.com/iframe/" sandbox="allow-scripts allow-popups" style="width: 100%;"></iframe><a id="cross-origin-frame-source"><h3>Cross origin frame source</h3><pre class="language-html"><code class="language-html"><span class="highlight-line"><span class="token doctype">&lt;!DOCTYPE html></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>open this frame in blank target<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>log<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> logEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>messages<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">const</span> messageEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      messageEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'flex'</span></span><br><span class="highlight-line">      messageEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>borderTop <span class="token operator">=</span> <span class="token string">'1px solid black'</span></span><br><span class="highlight-line">      messageEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token string">'1rem 0'</span></span><br><span class="highlight-line">      <span class="token keyword">const</span> spans <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>message <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">const</span> span <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        span<span class="token punctuation">.</span>style<span class="token punctuation">.</span>flex <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">100</span> <span class="token operator">/</span> messages<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%`</span></span></span><br><span class="highlight-line">        span<span class="token punctuation">.</span>textContent <span class="token operator">=</span> message</span><br><span class="highlight-line">        messageEl<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      logEl<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>messageEl<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    logEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line">    logEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>margin <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> <span class="token function-variable function">tryToReadWidowProp</span> <span class="token operator">=</span> str <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">const</span> path <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">,</span> window<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        result <span class="token operator">=</span> error<span class="token punctuation">.</span>message</span><br><span class="highlight-line">      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> result</span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> locationHref <span class="token operator">=</span> <span class="token function">tryToReadWidowProp</span><span class="token punctuation">(</span><span class="token string">'location.href'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> topLocationHref <span class="token operator">=</span> <span class="token function">tryToReadWidowProp</span><span class="token punctuation">(</span><span class="token string">'top.location.href'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'window location:'</span><span class="token punctuation">,</span> locationHref<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'top location:'</span><span class="token punctuation">,</span> topLocationHref<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'opener location:'</span><span class="token punctuation">,</span> <span class="token function">tryToReadWidowProp</span><span class="token punctuation">(</span><span class="token string">'opener.location.href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'opener top location:'</span><span class="token punctuation">,</span> <span class="token function">tryToReadWidowProp</span><span class="token punctuation">(</span><span class="token string">'opener.top.location.href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>locationHref <span class="token operator">===</span> topLocationHref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      button<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'open this frame in a blank target'</span></span><br><span class="highlight-line">      button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span> <span class="token string">'_blank'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>opener<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      button<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'navigate top frame of opener to example.com'</span></span><br><span class="highlight-line">      button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> opener<span class="token punctuation">.</span>top<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'//example.com'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>  </span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span></code></pre></a></main><footer><ul><li><a href="https://www.linkedin.com/in/adamsbuczek/"><img src="/assets/linkedin.svg" alt="LinkedIn"></a></li><li><a href="https://github.com/adambuczek"><img src="/assets/github.svg" alt="Github"></a></li><li><a href="https://codepen.io/adambuczek"><img src="/assets/codepen.svg" alt="Codepen"></a></li></ul></footer><link href="/styles/global.css" rel="stylesheet" type="text/css"><link href="/styles/print.css" media="print" rel="stylesheet" type="text/css"></body></html>